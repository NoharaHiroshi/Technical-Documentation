# HLS 实现流媒体的点播和直播播放 #

> 在我分析一款网络直播App的数据请求时，发现App请求的是m3u8后缀名的文件，稍微研究了一下。

**M38U是什么？**

先说M3U, M3U是一种播放媒体列表的文件格式。设计的的初衷是为了播放音频文件列表，后续也开始用来播放视频文件列表。M3U的Unicode版本就是M3U8，用UTF-8编码。

简单来说M38U就是一个播放列表。如下列：

	#EXTM3U
	#EXT-X-VERSION:3
	#EXT-X-MEDIA-SEQUENCE:28737
	#EXT-X-TARGETDURATION:4
	#EXTINF:3.024,
	datong_jinji/1550313917_28737.ts?auth_key=1672633337-0-0-f3a65879a6e0f43fb6393dc9048fbb44
	#EXTINF:3.016,
	datong_jinji/1550313920_28738.ts?auth_key=1672633337-0-0-cfbaabcdb7cc938149d7ea261b12b972
	#EXTINF:3.016,
	datong_jinji/1550313923_28739.ts?auth_key=1672633337-0-0-64e4837c2055260eab141583cec9c8e7
	

**HLS是什么？**

M3U和M3U8文件都是依托HTTP Live Streaming（HLS）流媒体协议，HLS （HTTP Live Streaming）是苹果公司实现的基于 HTTP 的流媒体协议，可以实现流媒体的点播和直播播放，主要用于PC和Apple终端的音视频服务。包括一个m3u(8)的索引文件、TS媒体分片文件和key加密串文件。

HLS协议规定：

- 视频的封装格式是TS。
- 视频的编码格式为H264,音频编码格式为MP3、AAC或者AC-3。
- 除了TS视频文件本身，还定义了用来控制播放的m3u8文件（文本文件）。

**HLS的优势与缺点**

为什么苹果要提出HLS这个协议，其实他的主要是为了解决RTMP协议存在的一些问题。比如RTMP协议不使用标准的HTTP接口传输数据，所以在一些特殊的网络环境下可能被防火墙屏蔽掉。但是HLS由于使用的HTTP协议传输数据，不会遇到被防火墙屏蔽的情况。

另外于负载，RTMP是一种有状态协议，很难对视频服务器进行平滑扩展，因为需要为每一个播放视频流的客户端维护状态。而HLS基于无状态协议（HTTP），客户端只是按照顺序使用下载存储在服务器的普通TS文件，做负责均衡如同普通的HTTP文件服务器的负载均衡一样简单。

另外HLS协议本身实现了码率自适应，不同带宽的设备可以自动切换到最适合自己码率的视频播放。

但HLS也有一些无法跨越的坑，比如采用HLS协议直播的视频延迟时间无法下到10秒以下，而RTMP协议的延迟最低可以到3、4秒左右。所以说对直播延迟比较敏感的服务请慎用HLS。

**HLS的实现逻辑**

客户端播放HLS视频流的逻辑其实非常简单，先下载一级Index file，它里面记录了二级索引文件（Alternate-A、Alternate-B、Alternate-C）的地址，然后客户端再去下载二级索引文件，二级索引文件中又记录了TS文件的下载地址，这样客户端就可以按顺序下载TS视频文件并连续播放。

	#EXTM3U
	#EXT-X-VERSION:3
	// EXT-X-MEDIA-SEQUENCE当前媒体流的序号
	#EXT-X-MEDIA-SEQUENCE:28737
	// EXT-X-TARGETDURATION当前媒体流中的切片文件的最大时长 
	#EXT-X-TARGETDURATION:4

	// 列表的文件数有限制，推荐配置是3个，服务端会实时更新该列表
	// EXTINF指定每个媒体段(ts)的持续时间（秒），仅对其后面的URI有效
	#EXTINF:3.024,
	datong_jinji/1550313917_28737.ts?auth_key=1672633337-0-0-f3a65879a6e0f43fb6393dc9048fbb44
	#EXTINF:3.016,
	datong_jinji/1550313920_28738.ts?auth_key=1672633337-0-0-cfbaabcdb7cc938149d7ea261b12b972
	#EXTINF:3.016,
	datong_jinji/1550313923_28739.ts?auth_key=1672633337-0-0-64e4837c2055260eab141583cec9c8e7

**HLS的请求流程**

1. http 请求 m3u8 的 url。

2. 服务端返回一个 m3u8 的播放列表，这个播放列表是实时更新的。

3. 客户端解析 m3u8 的播放列表，再按序请求每一段的 url，获取 ts 数据流。

**HLS的直播延迟**

HLS的直播并不是实时的，当我们看到直播视频的时候，其实是已经录制好的视频。只是这个录制视频的时间与我们看到视频的时间之间间隔很短，这个间隔就叫做延迟。

我们知道 hls 协议是将直播流分成一段一段的小段视频去下载播放的，所以假设列表里面的包含5个 ts 文件，每个 TS 文件包含5秒的视频内容，那么整体的延迟就是25秒。

当然可以缩短列表的长度和单个 ts 文件的大小来降低延迟，极致来说可以缩减列表长度为1，并且 ts 的时长为1s，但是这样会造成请求次数增加，增大服务器压力，当网速慢时回造成更多的缓冲，所以苹果官方推荐的ts时长时10s，所以这样就会大改有30s的延迟。