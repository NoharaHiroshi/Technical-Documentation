20190130-钉钉系统对接调研

## 问题背景描述 ##

遇到要系统与钉钉对接OA的需求，通过接口获取钉钉内企业创建合同以及签章的审批结果，研究钉钉提供的现有接口是否能够实现需求。

## 问题知识储备 ##

**对接模式**

由企业创建钉钉应用，授权给服务商进行定制化开发，服务商可以调用钉钉提供的接口（包括企业通讯录、消息通知、待办事项、审批、考情等）定制化开发。开发完成后，企业用户在钉钉中使用开发的应用。

**对接流程**

服务商要获得企业的授权开发，必须在钉钉开放平台申请成为定制服务商。非认证通过的定制商无法获得企业授权。

企业先创建应用，选择-授权给服务商开发。

1. 服务商将自己的corpid提供给企业，作为企业授权的唯一标志。
2. 服务商提供接口回调ip**（为不同企业提供服务，提供的IP不能重复，是钉钉为了企业应用体验的稳定）**
3. 企业限定可使用范围，企业哪些员工可以使用。
4. 企业限定应用权限。

服务商进入开发者平台，通过获取企业授权的access_token调用接口。

**重要节点**

1、免密登录

目前的理解是用户进入服务商开发的微应用后，不需要输入用户的账号密码，就能获取用户信息。 具体实现步骤是：用户进入微应用，会向微应用发送一个免登授权码AuthCode作为用户标识，通过免登授权码和access_token获得用户的userId。

可以实现单点登录，用户首次进入微应用，要求用户和系统账户做绑定，下次进入应用时即可直接登录系统。

2、审批

服务商默认没有审批接口的使用权限，如需使用，需要向钉钉isv沟通组提交审批流程，审核通过后工作人员会开通该微应用的审批接口权限（每个要服务的企业都需要申请一遍？）

钉钉通过接口开放的发起审批只支持单行输入框、图片、明细。

服务商需要在自己的账户下创建一个审批流，并调用复制审批流接口，把系统创建的审批模板复制到企业中，并获得复制到企业后审批流的process_code。也可以由企业用户创建审批流程，提供给系统。

服务商需要在系统中开发一个自己的审批表单页面，用于企业用户在系统中创建审批流程。

审批的结果将会通过钉钉的RDS推送。

## 解决问题方案 ##

目前钉钉提供的接口可以实现用户在系统中创建业务，并使用钉钉的OA系统。
